<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Timbratrice Web</title>

  <style>
    /* Modal (div-based, no <dialog>) */
.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
  z-index:9999;
}
@media (prefers-color-scheme: light){
  .modalOverlay{background:rgba(0,0,0,.25)}
}
.modalCard{
  width:min(560px, calc(100% - 28px));
  background:var(--card);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
    :root{
      --bg:#0b0b0c;
      --card:#141417;
      --card2:#17171b;
      --text:#f2f2f2;
      --muted:#b8b8bf;
      --line:rgba(255,255,255,.10);
      --red:#D22B2B;
      --red2:#b21f1f;
      --good:#3ddc84;
      --warn:#ffb020;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f5f7;
        --card:#ffffff;
        --card2:#fafafa;
        --text:#121212;
        --muted:#6c6c75;
        --line:rgba(0,0,0,.10);
        --shadow: 0 10px 30px rgba(0,0,0,.10);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:linear-gradient(180deg, rgba(210,43,43,.12), transparent 40%), var(--bg);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    @media (prefers-color-scheme: light){
      .topbar{background:rgba(255,255,255,.70)}
    }
    .brand{font-weight:900; letter-spacing:.2px}
    .right{display:flex; align-items:center; gap:10px}
    .userPill{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      max-width:52vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .iconBtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
    }

    .wrap{max-width:720px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:14px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .punch{
      padding:16px;
      border:2px solid rgba(210,43,43,.35);
      box-shadow:none;
    }
    .punchHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .punchTitle{font-size:22px; font-weight:900; letter-spacing:.2px}
    .pill{
      padding:7px 12px;
      border-radius:999px;
      font-weight:800;
      border:1px solid var(--line);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill.ready{color:#2d7dff}
    .pill.run{color:var(--good)}
    .pill.pause{color:var(--warn)}
    .spinner{
      width:14px; height:14px; border-radius:50%;
      border:2px solid currentColor; border-right-color:transparent;
      display:inline-block;
      animation: spin 1.2s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .netRow{display:flex; align-items:center; justify-content:space-between; margin-top:10px; gap:10px}
    .netTime{
      font-family:var(--mono);
      font-size:54px;
      font-weight:900;
      letter-spacing:-.5px;
    }
    .bigIcon{
      width:52px;height:52px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(210,43,43,.12);
      border:1px solid rgba(210,43,43,.25);
      font-size:26px;
      user-select:none;
    }

    .chips{display:flex; gap:10px; margin-top:8px}
    .chips3{display:flex; gap:10px; margin-top:12px}
    .chip{
      flex:1;
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:10px 12px;
      min-width:0;
    }
    .chipLabel{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.2px}
    .chipValue{
      margin-top:4px;
      font-family:var(--mono);
      font-size:18px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    @media (max-width:520px){.grid2{grid-template-columns:1fr}}
    .field{display:flex; flex-direction:column; gap:6px}
    .field > span{font-size:12px; color:var(--muted); font-weight:800}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    input:focus{border-color: rgba(210,43,43,.55)}
    .actions{display:flex; gap:10px; margin-top:14px}
    .btn{
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      flex:1;
    }
    .btn.primary{
      background:linear-gradient(180deg, var(--red), var(--red2));
      border-color:rgba(255,255,255,.10);
      color:white;
    }
    .btn.danger{background:rgba(255,70,70,.10); border-color:rgba(255,70,70,.25)}
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .summaryHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .h2{font-weight:900; font-size:18px}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .toggle{display:flex; align-items:center; gap:8px; user-select:none; color:var(--muted); font-weight:900}
    .toggle input{width:18px; height:18px}

    .filterBox{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    @media (max-width:520px){.filterBox{grid-template-columns:1fr}}
    .row{display:flex; gap:10px; margin-top:12px}

    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .itemTitle{font-weight:900}
    .itemMeta{font-family:var(--mono); color:var(--muted); font-size:12px}
    .itemBtns{display:flex; gap:10px}
    .miniBtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .miniBtn.d{border-color:rgba(255,70,70,.25); background:rgba(255,70,70,.08)}
    .empty{
      text-align:center;
      color:var(--muted);
      padding:18px 8px;
      border:1px dashed var(--line);
      border-radius:16px;
      margin-top:10px;
    }
    .hidden{display:none!important}

    dialog.dlg{
      border:none;
      border-radius:18px;
      padding:0;
      width:min(560px, calc(100% - 28px));
      background:var(--card);
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
    }
    .dlgInner{padding:16px; display:flex; flex-direction:column; gap:12px}
    .dlgTitle{font-weight:900; font-size:18px}
    .msg{font-size:13px; color:var(--muted)}
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      border:1px dashed var(--line);
      background:rgba(0,0,0,.06);
      padding:10px 12px;
      border-radius:14px;
    }
    @media (prefers-color-scheme: light){
      .hint{background:rgba(0,0,0,.03)}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">Timbratrice</div>
    <div class="right">
      <div id="userPill" class="userPill">Non loggato</div>
      <button id="btnSettings" class="iconBtn" aria-label="Account">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card punch">
      <div class="punchHead">
        <div class="punchTitle">Timbratrice</div>
        <div id="statusPill" class="pill ready">‚úÖ Pronto</div>
      </div>

      <div class="netRow">
        <div class="netTime" id="netTime">0:00</div>
        <div class="bigIcon" id="bigIcon">‚úÖ</div>
      </div>

      <div class="chips">
        <div class="chip">
          <div class="chipLabel">Pausa</div>
          <div class="chipValue" id="pauseVal">0:00</div>
        </div>
        <div class="chip">
          <div class="chipLabel">Km</div>
          <div class="chipValue" id="kmVal">0</div>
        </div>
      </div>

      <div class="grid2">
        <label class="field">
          <span>Titolo</span>
          <input id="titleInput" type="text" placeholder="Opzionale">
        </label>

        <label class="field">
          <span>Km</span>
          <input id="kmInput" inputmode="numeric" type="text" placeholder="0">
        </label>
      </div>

      <div class="actions">
        <button id="btnStart" class="btn primary">Inizia turno</button>
        <button id="btnBreak" class="btn">Inizia pausa</button>
        <button id="btnStop" class="btn danger">Stop</button>
      </div>

      <div id="loginHint" class="hint" style="margin-top:12px">
        üîê Per sincronizzare su Supabase: apri ‚öôÔ∏è, fai login (o registrati) e poi usa l‚Äôapp normalmente.
      </div>
    </section>

    <section class="card">
      <div class="summaryHead">
        <div>
          <div class="h2">Riepilogo</div>
          <div class="sub" id="rangeText">Storico: tutti</div>
        </div>

        <label class="toggle">
          <input id="filterToggle" type="checkbox" />
          <span>Filtra</span>
        </label>
      </div>

      <div class="chips3">
        <div class="chip">
          <div class="chipLabel">Turni</div>
          <div class="chipValue" id="sumTurns">0</div>
        </div>
        <div class="chip">
          <div class="chipLabel">Ore</div>
          <div class="chipValue" id="sumHours">0:00</div>
        </div>
        <div class="chip">
          <div class="chipLabel">Km</div>
          <div class="chipValue" id="sumKm">0</div>
        </div>
      </div>

      <div id="filterBox" class="filterBox hidden">
        <label class="field">
          <span>Da</span>
          <input id="fromDate" type="date" />
        </label>
        <label class="field">
          <span>A</span>
          <input id="toDate" type="date" />
        </label>
      </div>

      <div class="row">
        <button id="btnRefresh" class="btn">Aggiorna</button>
        <button id="btnExport" class="btn">Esporta CSV</button>
      </div>
    </section>

    <section class="card">
      <div class="h2">Storico</div>
      <div id="list" class="list"></div>
      <div id="empty" class="empty hidden">Nessun record</div>
    </section>
  </main>

<div id="settingsDlg" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-label="Account e impostazioni">
  <div class="modalCard">
    <form class="dlgInner" onsubmit="return false;">
      <div class="dlgTitle">Account & Impostazioni</div>

      <div class="hint">
        ‚úÖ Hai gi√† fatto Supabase. Qui devi solo inserire email/password per login o registrazione.
        <br>Il nome report serve per il file CSV.
      </div>

      <label class="field">
        <span>Email</span>
        <input id="emailInput" type="email" placeholder="tuo@email.com" autocomplete="email">
      </label>

      <label class="field">
        <span>Password</span>
        <input id="passInput" type="password" placeholder="min 6 caratteri" autocomplete="current-password">
      </label>

      <label class="field">
        <span>Nome report (export)</span>
        <input id="reportInput" type="text" placeholder="Report di Giovanni">
      </label>

      <div class="row">
        <button id="btnLogin" type="button" class="btn primary">Login</button>
        <button id="btnSignup" type="button" class="btn">Registrati</button>
      </div>

      <div class="row">
        <button id="btnLogout" type="button" class="btn danger">Logout</button>
        <button id="btnCloseDlg" type="button" class="btn">Chiudi</button>
      </div>

      <div id="settingsMsg" class="msg"></div>
    </form>
  </div>
</div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================================================
    // ===== SUPABASE CONFIG (INC0LLA QUI) ======================
    // =========================================================
    const SUPABASE_URL_RAW = "https://rvznuudatshqyzmnqrmd.supabase.co";   // es: https://xxxxx.supabase.co
    const SUPABASE_ANON_KEY_RAW = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2em51dWRhdHNocXl6bW5xcm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3Njg5NTcsImV4cCI6MjA4MjM0NDk1N30.0_KKO88ExW4_WHXhR2fuVuLWNBmI3xXKMth4A2qqVr4"; // Settings -> API -> anon public

    // --- debug helpers (DISABILITATI: niente barra rossa) ---
    function showDebug(_msg){}
    function hideDebug(){}
    window.addEventListener("error", (e)=>{
      console.error("JS error:", e?.message || e);
    });
    window.addEventListener("unhandledrejection", (e)=>{
      console.error("Promise error:", e?.reason || e);
    });

    const SUPABASE_URL = (SUPABASE_URL_RAW || "").trim();
    const SUPABASE_ANON_KEY = (SUPABASE_ANON_KEY_RAW || "").trim();

    if(!/^https?:\/\//i.test(SUPABASE_URL)){
      console.warn(`SUPABASE_URL non valido: "${SUPABASE_URL}"`);
    }

    let sb = null;
    try{
      if(!window.supabase || typeof window.supabase.createClient !== "function"){
        throw new Error("Supabase SDK non caricato (CDN bloccato o offline)");
      }
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }catch(err){
      showDebug("‚ùå Init Supabase: " + (err.message || String(err)));
    }

    // --------- utilities ---------
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2, "0");
    const fmtHM = (min) => {
      const m = Math.max(0, Math.floor(Number(min || 0)));
      const h = Math.floor(m / 60);
      const mm = m % 60;
      return `${h}:${pad2(mm)}`;
    };
    const toISO = (d) => new Date(d).toISOString();

    function todayISODate(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      return `${yyyy}-${mm}-${dd}`;
    }

    // --------- local settings ---------
    const LS = {
      get(key, def=""){ try{ return localStorage.getItem(key) ?? def; }catch{ return def; } },
      set(key, val){ try{ localStorage.setItem(key, val); }catch{} },
    };
    const KEYS = { report: "tw_report" };

    function cfg(){
      const report = (LS.get(KEYS.report,"Report")||"Report").trim();
      return { report };
    }

    // --------- app state ---------
    let active = null;   // {id,title,startISO,endISO,pauseMin,workMin,km,notes,breakStartISO}
    let history = [];    // ended only

    // Draft values for the NEXT shift (used only when no active shift)
    let draftTitle = "";
    let draftKm = "";

    // Debounced save for live edits on the active record
    let activeEditSaveTimer = null;
    function saveActiveEditsDebounced(){
      if(!active) return;
      if(activeEditSaveTimer) clearTimeout(activeEditSaveTimer);
      activeEditSaveTimer = setTimeout(async ()=>{
        try{
          await upsertRow(active);
          // niente refresh mentre scrivi: evita "saltelli"
        }catch(e){
          console.error(e);
        }
      }, 450);
    }

    function syncInputsWithState(){
      const t = $("titleInput");
      const k = $("kmInput");
      if(!t || !k) return;

      if(active){
        t.value = active.title || "";
        k.value = (active.km ?? 0) === 0 ? "" : String(active.km);
      }else{
        t.value = draftTitle || "";
        k.value = draftKm || "";
      }
    }

    // --------- auth helpers ---------
    async function getUser(){
      if(!sb) return null;
      const { data, error } = await sb.auth.getUser();
      if(error) return null;
      return data.user || null;
    }

    function setUserUI(user){
      const pill = $("userPill");
      const hint = $("loginHint");
      if(user){
        pill.textContent = user.email || "Loggato";
        hint.classList.add("hidden");
      }else{
        pill.textContent = "Non loggato";
        hint.classList.remove("hidden");
      }
    }

    async function signUp(email, password){
      if(!sb) throw new Error("Supabase non inizializzato.");

      // Redirect di conferma: torna alla stessa cartella della webapp (GitHub Pages /timbratrice-web/)
      // new URL('./', ...) rimuove hash e query e mantiene lo slash finale.
      const redirectTo = new URL('./', window.location.href).toString();

      const { error } = await sb.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: redirectTo
        }
      });
      if(error) throw error;
    }

    async function signIn(email, password){
      if(!sb) throw new Error("Supabase non inizializzato.");
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error) throw error;
    }

    async function signOut(){
      const { error } = await sb.auth.signOut();
      if(error) throw error;
    }

    if(sb){
      sb.auth.onAuthStateChange(async () => {
        const user = await getUser();
        setUserUI(user);
        await refresh();
      });
    }

    // --------- core computations ---------
    function computeWorkMin(row, nowISO){
      const start = row.startISO ? new Date(row.startISO) : new Date(nowISO);
      const end = row.endISO ? new Date(row.endISO) : new Date(nowISO);
      const totalMin = Math.max(0, Math.floor((end - start)/60000));
      const work = Math.max(0, totalMin - (Number(row.pauseMin)||0));
      return work;
    }

    function getFilterFromISO(){
      if(!$("filterToggle").checked) return "";
      const v = $("fromDate").value;
      if(!v) return "";
      return new Date(v + "T00:00:00").toISOString();
    }
    function getFilterToISO(){
      if(!$("filterToggle").checked) return "";
      const v = $("toDate").value;
      if(!v) return "";
      return new Date(v + "T23:59:59").toISOString();
    }

    // --------- Supabase CRUD ---------
    async function refresh(){
      const user = await getUser();
      if(!sb){
        console.warn("Supabase non inizializzato: controlla connessione/CDN/config");
        active = null;
        history = [];
        renderAll();
        return;
      }
      if(!user){
        active = null;
        history = [];
        renderAll();
        return;
      }

      let q = sb
        .from("work_records")
        .select("*")
        .eq("user_id", user.id)
        .order("start_ts", { ascending: false });

      const fromISO = getFilterFromISO();
      const toISO = getFilterToISO();
      if(fromISO && toISO){
        q = q.gte("start_ts", fromISO).lte("start_ts", toISO);
      }

      const { data, error } = await q;
      if(error){
        console.error(error);
        alert(error.message);
        return;
      }

      const rows = (data || []).map(r => ({
        id: r.id,
        title: r.title || "",
        startISO: r.start_ts ? new Date(r.start_ts).toISOString() : "",
        endISO: r.end_ts ? new Date(r.end_ts).toISOString() : "",
        pauseMin: Number(r.pause_min || 0),
        workMin: Number(r.work_min || 0),
        km: Number(r.km || 0),
        notes: r.notes || "",
        breakStartISO: r.break_start_ts ? new Date(r.break_start_ts).toISOString() : ""
      }));

      active = rows.find(r => !r.endISO) || null;
      history = rows.filter(r => !!r.endISO);

      syncInputsWithState();
      renderAll();
    }

    async function upsertRow(row){
      if(!sb) throw new Error("Supabase non inizializzato.");
      const user = await getUser();
      if(!user) throw new Error("Fai login (‚öôÔ∏è) per salvare.");

      const payload = {
        id: row.id,                 // uuid
        user_id: user.id,
        title: row.title || "",
        start_ts: row.startISO || null,
        end_ts: row.endISO || null,
        pause_min: Number(row.pauseMin || 0),
        work_min: Number(row.workMin || 0),
        km: Number(row.km || 0),
        notes: row.notes || "",
        break_start_ts: row.breakStartISO || null,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb
        .from("work_records")
        .upsert(payload, { onConflict: "id" });

      if(error) throw error;
    }

    async function deleteRow(id){
      if(!sb) throw new Error("Supabase non inizializzato.");
      const user = await getUser();
      if(!user) throw new Error("Fai login (‚öôÔ∏è) per cancellare.");

      const { error } = await sb
        .from("work_records")
        .delete()
        .eq("id", id)
        .eq("user_id", user.id);

      if(error) throw error;
    }

    // --------- actions ---------
    function newId(){
      if (typeof crypto !== "undefined" && crypto.randomUUID) {
        return crypto.randomUUID(); // uuid puro (compatibile col tipo uuid in db)
      }
      // Ultimo fallback (non crittografico) ‚Äî ma in formato UUID v4 valido
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        const v = (c === "x") ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    async function startShift(){
      const user = await getUser();
      if(!user){ alert("Fai login (‚öôÔ∏è) per iniziare e salvare."); return; }
      if(active) return;

      const titleRaw = ($("titleInput").value || "").trim();
      const kmRaw = ($("kmInput").value || "").trim();

      draftTitle = titleRaw;
      draftKm = kmRaw;

      const title = titleRaw || `Turno ${new Date().toLocaleDateString("it-IT")}`;
      const km = parseFloat(kmRaw.replace(",", ".")) || 0;

      const now = new Date();
      const row = {
        id: newId(),
        title,
        startISO: toISO(now),
        endISO: "",
        pauseMin: 0,
        workMin: 0,
        km,
        notes:"",
        breakStartISO:""
      };

      active = row;
      syncInputsWithState();
      try{
        await upsertRow(row);
        await refresh();
      }catch(e){
        alert(e.message || String(e));
      }
    }

    async function toggleBreak(){
      const user = await getUser();
      if(!user){ alert("Fai login (‚öôÔ∏è)."); return; }
      if(!active) return;

      const nowISO = toISO(new Date());

      // start break
      if(!active.breakStartISO){
        active.breakStartISO = nowISO;
        try{
          await upsertRow(active);
          await refresh();
        }catch(e){ alert(e.message || String(e)); }
        return;
      }

      // end break
      const bs = new Date(active.breakStartISO);
      const now = new Date(nowISO);
      const addMin = Math.max(0, Math.floor((now - bs)/60000));
      active.pauseMin = Number(active.pauseMin||0) + addMin;
      active.breakStartISO = "";
      active.workMin = computeWorkMin(active, nowISO);

      try{
        await upsertRow(active);
        await refresh();
      }catch(e){ alert(e.message || String(e)); }
    }

    async function stopShift(){
      const user = await getUser();
      if(!user){ alert("Fai login (‚öôÔ∏è)."); return; }
      if(!active) return;

      const nowISO = toISO(new Date());

      // if break running -> close it first
      if(active.breakStartISO){
        const bs = new Date(active.breakStartISO);
        const now = new Date(nowISO);
        const addMin = Math.max(0, Math.floor((now - bs)/60000));
        active.pauseMin = Number(active.pauseMin||0) + addMin;
        active.breakStartISO = "";
      }

      active.endISO = nowISO;
      active.workMin = computeWorkMin(active, nowISO);

      try{
        await upsertRow(active);
        active = null;
        syncInputsWithState();
        await refresh();
      }catch(e){
        alert(e.message || String(e));
      }
    }

    // --------- UI rendering ---------
    function renderAll(){
      const now = new Date();
      const pill = $("statusPill");
      const bigIcon = $("bigIcon");

      let netMin = 0;
      let pauseMin = 0;

      if(!active){
        pill.className = "pill ready";
        pill.textContent = "‚úÖ Pronto";
        bigIcon.textContent = "‚úÖ";
        $("btnStart").disabled = false;
        $("btnBreak").disabled = true;
        $("btnStop").disabled = true;
        $("btnBreak").textContent = "Inizia pausa";
        $("kmVal").textContent = "0";
      }else{
        const isPause = !!active.breakStartISO;

        pill.className = "pill " + (isPause ? "pause" : "run");
        pill.innerHTML = isPause ? `‚è∏Ô∏é Pausa` : `<span class="spinner"></span> In corso`;
        bigIcon.textContent = isPause ? "‚è∏Ô∏é" : "üïí";

        $("btnStart").disabled = true;
        $("btnBreak").disabled = false;
        $("btnBreak").textContent = isPause ? "Fine pausa" : "Inizia pausa";
        $("btnStop").disabled = false;

        const nowISO = toISO(now);
        pauseMin = Number(active.pauseMin||0);
        if(active.breakStartISO){
          const bs = new Date(active.breakStartISO);
          pauseMin += Math.max(0, Math.floor((now - bs)/60000));
        }
        const temp = {...active, pauseMin};
        netMin = computeWorkMin(temp, nowISO);
        $("kmVal").textContent = String(Number(active.km||0));
      }

      $("netTime").textContent = fmtHM(netMin);
      $("pauseVal").textContent = fmtHM(pauseMin);

      // summary (solo turni chiusi)
      const turns = history.length;
      const sumWorkMin = history.reduce((a,r)=>a + Number(r.workMin||0), 0);
      const sumKm = history.reduce((a,r)=>a + Number(r.km||0), 0);
      $("sumTurns").textContent = String(turns);
      $("sumHours").textContent = fmtHM(sumWorkMin);
      $("sumKm").textContent = String(sumKm);

      const ft = $("filterToggle").checked;
      if(ft && $("fromDate").value && $("toDate").value){
        $("rangeText").textContent = `Selezione: ${$("fromDate").value} ‚Üí ${$("toDate").value}`;
      }else{
        $("rangeText").textContent = "Storico: tutti";
      }

      // list
      const list = $("list");
      list.innerHTML = "";
      if(history.length === 0){
        $("empty").classList.remove("hidden");
      }else{
        $("empty").classList.add("hidden");
        const sorted = [...history].sort((a,b)=> (b.startISO||"").localeCompare(a.startISO||""));
        for(const r of sorted){
          const start = r.startISO ? new Date(r.startISO).toLocaleString("it-IT") : "";
          const end = r.endISO ? new Date(r.endISO).toLocaleString("it-IT") : "";
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
            <div class="itemTop">
              <div>
                <div class="itemTitle">${escapeHTML(r.title || "Senza titolo")}</div>
                <div class="itemMeta">Inizio: ${escapeHTML(start)}  ‚Ä¢  Fine: ${escapeHTML(end)}</div>
                <div class="itemMeta">Ore: ${escapeHTML(fmtHM(r.workMin||0))}  ‚Ä¢  Km: ${escapeHTML(String(r.km||0))}</div>
              </div>
              <div class="itemBtns">
                <button class="miniBtn d" data-del="${r.id}">Elimina</button>
              </div>
            </div>
          `;
          list.appendChild(el);
        }
        list.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            const id = e.currentTarget.getAttribute("data-del");
            if(!confirm("Eliminare questo record?")) return;
            try{
              await deleteRow(id);
              await refresh();
            }catch(err){
              alert(err.message || String(err));
            }
          });
        });
      }
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // --------- CSV export (turni + ore nette + km) ---------
    function exportCSV(){
      const { report } = cfg();
      const sep = ";";
      const rows = [...history].sort((a,b)=> (a.startISO||"").localeCompare(b.startISO||""));

      const dt = (iso)=>{
        if(!iso) return "";
        const d = new Date(iso);
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const HH = pad2(d.getHours());
        const MI = pad2(d.getMinutes());
        return `${yyyy}/${mm}/${dd} ${HH}:${MI}`;
      };

      let csv = "\uFEFF";
      csv += ["Titolo","DataOraInizio","DataOraFine","Ore_nette_hh:mm","Km"].join(sep) + "\r\n";

      let sumWork = 0, sumKm = 0;

      for(const r of rows){
        sumWork += Number(r.workMin||0);
        sumKm += Number(r.km||0);
        csv += [
          csvEscape(r.title||"", sep),
          dt(r.startISO),
          dt(r.endISO),
          fmtHM(Number(r.workMin||0)),
          String(Number(r.km||0))
        ].join(sep) + "\r\n";
      }

      csv += ["TOTALE SELEZIONE","","", fmtHM(sumWork), String(sumKm)].join(sep) + "\r\n";
      csv += "\r\n";
      csv += ["RIEPILOGO","","","",""].join(sep) + "\r\n";
      csv += ["Turni", String(rows.length), "","",""].join(sep) + "\r\n";
      csv += ["Ore totali (nette)", fmtHM(sumWork), "","",""].join(sep) + "\r\n";
      csv += ["Km totali", String(sumKm), "","",""].join(sep) + "\r\n";

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      const safe = (report || "timbratrice").replace(/[^\w\-]+/g,"-");
      a.href = URL.createObjectURL(blob);
      a.download = `${safe}-${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function csvEscape(s, sep){
      const t = String(s||"").trim();
      if(t.includes(sep) || t.includes('"') || t.includes("\n") || t.includes("\r")){
        return `"${t.replace(/"/g,'""')}"`;
      }
      return t;
    }

    // --------- events ---------
    const settingsDlg = $("settingsDlg");
    const settingsMsg = $("settingsMsg");
    let settingsJustOpenedAt = 0;

    function openSettings(){
      settingsJustOpenedAt = Date.now();
      settingsDlg.classList.remove("hidden");
    }
    function closeSettings(){
      // salva nome report quando chiudi
      LS.set(KEYS.report, ($("reportInput").value || "Report").trim());
      settingsDlg.classList.add("hidden");
    }

    // click fuori dalla card = chiudi (ma evita il tap che ha aperto il modal su iOS)
    settingsDlg.addEventListener("click", (e)=>{
      if(e.target === settingsDlg){
        if(Date.now() - settingsJustOpenedAt < 250) return; // evita chiusura immediata
        closeSettings();
      }
    });

$("btnSettings").addEventListener("click", ()=>{
  settingsMsg.textContent = "";
  $("reportInput").value = cfg().report;

  openSettings(); // apri SUBITO, senza async/timeout

  // poi (in background) se sei loggato compila l‚Äôemail
  getUser().then(user => {
    if(user) $("emailInput").value = user.email || "";
  }).catch(()=>{});
});



    $("btnLogin").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        const email = ($("emailInput").value||"").trim();
        const pass = ($("passInput").value||"").trim();
        if(!email || !pass) throw new Error("Inserisci email e password.");
        await signIn(email, pass);
        settingsMsg.textContent = "‚úÖ Login OK";
        // chiudi dopo un attimo (l'onAuthStateChange aggiorna UI e dati)
        setTimeout(closeSettings, 350);
      }catch(err){
        settingsMsg.textContent = "‚ùå " + (err.message || String(err));
      }
    });

    $("btnSignup").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        const email = ($("emailInput").value||"").trim();
        const pass = ($("passInput").value||"").trim();
        if(!email || !pass) throw new Error("Inserisci email e password.");
        if(pass.length < 6) throw new Error("Password troppo corta (min 6).");
        await signUp(email, pass);
        settingsMsg.textContent = "‚úÖ Registrazione OK. Controlla l‚Äôemail e apri il link di conferma subito (i link vecchi possono scadere). Poi fai Login.";
      }catch(err){
        settingsMsg.textContent = "‚ùå " + (err.message || String(err));
      }
    });

    $("btnLogout").addEventListener("click", async (e)=>{
      e.preventDefault();
      try{
        await signOut();
        settingsMsg.textContent = "‚úÖ Logout";
        setTimeout(closeSettings, 350);
      }catch(err){
        settingsMsg.textContent = "‚ùå " + (err.message || String(err));
      }
    });
$("btnCloseDlg").addEventListener("click", closeSettings);

    $("btnStart").addEventListener("click", startShift);
    $("btnBreak").addEventListener("click", toggleBreak);

    // Live edit bindings for Titolo / Km
    $("titleInput").addEventListener("input", ()=>{
      const v = $("titleInput").value || "";
      if(active){
        active.title = v;
        saveActiveEditsDebounced();
      }else{
        draftTitle = v;
      }
    });

    $("kmInput").addEventListener("input", ()=>{
      const raw = ($("kmInput").value || "").trim();
      if(active){
        const km = parseFloat(raw.replace(",","."));
        active.km = isFinite(km) ? km : 0;
        saveActiveEditsDebounced();
      }else{
        draftKm = raw;
      }
    });
    $("btnStop").addEventListener("click", ()=>{
      if(confirm("Finire il turno?")) stopShift();
    });

    $("btnRefresh").addEventListener("click", refresh);
    $("btnExport").addEventListener("click", exportCSV);

    $("filterToggle").addEventListener("change", async ()=>{
      const on = $("filterToggle").checked;
      $("filterBox").classList.toggle("hidden", !on);
      await refresh();
    });

    $("fromDate").addEventListener("change", async ()=>{
      if($("toDate").value && $("fromDate").value > $("toDate").value){
        $("toDate").value = $("fromDate").value;
      }
      await refresh();
    });
    $("toDate").addEventListener("change", async ()=>{
      if($("fromDate").value && $("toDate").value < $("fromDate").value){
        $("fromDate").value = $("toDate").value;
      }
      await refresh();
    });

    // live updates while active (solo UI, non scrive su DB)
    setInterval(()=>{ if(active) renderAll(); }, 1000);

    // init
    (async function boot(){
      try{
        $("fromDate").value = todayISODate(new Date(new Date().setDate(new Date().getDate()-7)));
        $("toDate").value = todayISODate();
        $("filterBox").classList.add("hidden");

        const user = await getUser();
        setUserUI(user);

        // Segnale visivo che il JS √® partito (se vedi questo, i bottoni sono collegati)
        // hideDebug(); // lasciamo la barra nascosta di default

        syncInputsWithState();
        await refresh();
      }catch(err){
        showDebug("‚ùå Boot: " + (err.message || String(err)));
      }
    })();
  </script>
</body>
</html>
